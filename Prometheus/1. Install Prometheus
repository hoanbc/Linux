###Download and unzip package
wget https://github.com/prometheus/prometheus/releases/download/v2.32.1/prometheus-2.32.1.linux-amd64.tar.gz
tar -xvf prometheus-2.32.1.linux-amd64.tar.gz
mv prometheus-2.32.1.linux-amd64 prometheus

###Create user prometheus
sudo useradd --no-create-home --shell /bin/false prometheus

###Create folder and copy file to folder
sudo mkdir /etc/prometheus
sudo mkdir /var/lib/prometheus
sudo mkdir /etc/prometheus/certs

cp prometheus/prometheus /usr/local/bin/
cp prometheus/promtool /usr/local/bin/
cp -r prometheus/consoles /etc/prometheus/
cp -r prometheus/console_libraries /etc/prometheus/

sudo chown -R prometheus:prometheus /usr/local/bin/prometheus
sudo chown -R prometheus:prometheus /usr/local/bin/promtool
sudo chown -R prometheus:prometheus /etc/prometheus
sudo chown -R prometheus:prometheus /var/lib/prometheus

###Config simple for prometheus
sudo vi /etc/prometheus/prometheus.yml
global:
  scrape_interval: 10s
  
scrape_configs:
  - job_name: 'srv-prometheus'
    scrape_interval: 10s
    scheme: https
    static_configs:
     - targets: ['prometheus.systemtest.xyz:9090']

  - job_name: 'srv-rhel1'
    scrape_interval: 10s
    static_configs:
      - targets: ['192.168.1.151:9100']

  - job_name: 'srv-rhel2'
    scrape_interval: 10s
    static_configs:
      - targets: ['192.168.1.152:9100']

###Enable https for prometheus
vim /etc/prometheus/web-config.yml
tls_server_config:
  cert_file: /etc/prometheus/certs/fullchain.pem
  key_file: /etc/prometheus/certs/privkey.pem

###Create service for prometheus
vim /etc/systemd/system/prometheus.service
[Unit]
Description=Prometheus
Wants=network-online.target
After=network-online.target

[Service]
User=prometheus
Group=prometheus
Type=simple
ExecStart=/usr/local/bin/prometheus \
    --config.file=/etc/prometheus/prometheus.yml \
    --web.config.file=/etc/prometheus/web-config.yml \
    --web.external-url=https://promethues.systemtest.xyz \
    --storage.tsdb.path=/var/lib/prometheus/ \
    --web.console.templates=/etc/prometheus/consoles \
    --web.console.libraries=/etc/prometheus/console_libraries \
    --web.enable-lifecycle

[Install]
WantedBy=multi-user.target

###Start and enable service with boot
sudo systemctl daemon-reload
sudo systemctl start prometheus
sudo systemctl status prometheus

###Open port for firewalld
firewall-cmd --add-port=9090/tcp --permanent
firewall-cmd --reload